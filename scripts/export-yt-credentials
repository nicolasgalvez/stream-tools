#!/usr/bin/env bash
# Export YouTube OAuth credentials from token.json to .env file
# Usage: ./scripts/export-yt-credentials [env-file]

set -e

TOKEN_FILE="${HOME}/.config/stream-tools/token.json"
ENV_FILE="${1:-.env}"

if [[ ! -f "$TOKEN_FILE" ]]; then
    echo "Error: Token file not found: $TOKEN_FILE"
    echo "Run 'yt auth login' first to authenticate."
    exit 1
fi

# Extract values from token.json
CLIENT_ID=$(jq -r '.client_id // empty' "$TOKEN_FILE")
CLIENT_SECRET=$(jq -r '.client_secret // empty' "$TOKEN_FILE")
REFRESH_TOKEN=$(jq -r '.refresh_token // empty' "$TOKEN_FILE")

if [[ -z "$CLIENT_ID" || -z "$CLIENT_SECRET" || -z "$REFRESH_TOKEN" ]]; then
    echo "Error: Token file is missing required fields."
    echo "Run 'yt auth login' to re-authenticate."
    exit 1
fi

# Update or create .env file
update_env_var() {
    local key="$1"
    local value="$2"
    local file="$3"

    if [[ -f "$file" ]] && grep -q "^${key}=" "$file"; then
        # Update existing value (macOS/BSD sed compatible)
        sed -i '' "s|^${key}=.*|${key}=${value}|" "$file"
    else
        # Append new value
        echo "${key}=${value}" >> "$file"
    fi
}

# Create .env if it doesn't exist
touch "$ENV_FILE"

update_env_var "YT_CLIENT_ID" "$CLIENT_ID" "$ENV_FILE"
update_env_var "YT_CLIENT_SECRET" "$CLIENT_SECRET" "$ENV_FILE"
update_env_var "YT_REFRESH_TOKEN" "$REFRESH_TOKEN" "$ENV_FILE"

echo "Updated $ENV_FILE with YouTube credentials:"
echo "  YT_CLIENT_ID=${CLIENT_ID:0:20}..."
echo "  YT_CLIENT_SECRET=${CLIENT_SECRET:0:10}..."
echo "  YT_REFRESH_TOKEN=${REFRESH_TOKEN:0:20}..."
